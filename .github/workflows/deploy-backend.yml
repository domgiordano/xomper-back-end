name: Deploy Backend

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r requirements.txt -t lambdas/common

      - name: Package Lambda functions
        run: |
          cd lambdas/authorizer
          zip -r ../../authorizer.zip *
          cd ../update_player_data
          zip -r ../../update-player-data.zip *
          cd ../get_player_data
          zip -r ../../get-player-data.zip *
          cd ../update_user_data
          zip -r ../../update-user-data.zip *
          cd ../get_user_data
          zip -r ../../get-user-data.zip *
          cd ../user_login
          zip -r ../../user-login.zip *
          cd ../update_league_data
          zip -r ../../update-league-data.zip *
          cd ../get_league_data
          zip -r ../../get-league-data.zip *
          cd ../..
          mkdir -p python/lambdas
          cp -r lambdas/common python/lambdas/
          python3.10 -m pip install --platform manylinux2014_x86_64 --only-binary=:all: -t python/ -r requirements.txt
          zip -r xomper-shared-packages.zip python

      ######################################################
      ######################################################
      ###                     LAYERS                      ##
      ######################################################
      ######################################################
      - name: Deploy Lambda Layer
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
        run: |
          LAYER_OUTPUT=$(aws lambda publish-layer-version \
            --layer-name xomper-shared-packages \
            --zip-file fileb://xomper-shared-packages.zip \
            --compatible-runtimes python3.10 \
            --region $AWS_REGION \
            --output json)

          echo "LAYER_ARN=$(echo $LAYER_OUTPUT | jq -r .LayerVersionArn)" >> $GITHUB_ENV
          echo "Layer ARN: $LAYER_ARN"

      ######################################################
      ######################################################
      ###                   AUTHORIZER                    ##
      ######################################################
      ######################################################
      - name: Deploy Authroizer Lambda Function Code
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
        run: |
          aws lambda update-function-code \
            --function-name xomper-authorizer \
            --zip-file fileb://authorizer.zip
          sleep 5

      - name: Deploy Authorizer Lambda Configurations
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
          LAYER_ARN: ${{ env.LAYER_ARN }}
        run: |
          aws lambda update-function-configuration \
            --function-name xomper-authorizer \
            --layers $LAYER_ARN \
            --region $AWS_REGION

      ######################################################
      ######################################################
      ###                 PLAYER DATA                     ##
      ######################################################
      ######################################################

      ## UPDATE PLAYER DATA 
      - name: Deploy Update Player Data Lambda Function Code
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
        run: |
          aws lambda update-function-code \
            --function-name xomper-update-player-data \
            --zip-file fileb://update-player-data.zip
          sleep 5

      - name: Deploy Update Player Data Lambda Configurations
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
          LAYER_ARN: ${{ env.LAYER_ARN }}
        run: |
          aws lambda update-function-configuration \
            --function-name xomper-update-player-data \
            --layers $LAYER_ARN \
            --region $AWS_REGION

      ## GET PLAYER DATA 
      - name: Deploy Get Player Data Lambda Function Code
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
        run: |
          aws lambda update-function-code \
            --function-name xomper-get-player-data \
            --zip-file fileb://get-player-data.zip
          sleep 5

      - name: Deploy Get Player Data Lambda Configurations
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
          LAYER_ARN: ${{ env.LAYER_ARN }}
        run: |
          aws lambda update-function-configuration \
            --function-name xomper-get-player-data \
            --layers $LAYER_ARN \
            --region $AWS_REGION

      ######################################################
      ######################################################
      ###                 USER DATA                       ##
      ######################################################
      ######################################################

      ## UPDATE USER DATA 
      - name: Deploy Update User Data Lambda Function Code
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
        run: |
          aws lambda update-function-code \
            --function-name xomper-update-user-data \
            --zip-file fileb://update-user-data.zip
          sleep 5

      - name: Deploy Update User Data Lambda Configurations
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
          LAYER_ARN: ${{ env.LAYER_ARN }}
        run: |
          aws lambda update-function-configuration \
            --function-name xomper-update-user-data \
            --layers $LAYER_ARN \
            --region $AWS_REGION

      ## GET USER DATA 
      - name: Deploy Get User Data Lambda Function Code
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
        run: |
          aws lambda update-function-code \
            --function-name xomper-get-user-data \
            --zip-file fileb://get-user-data.zip
          sleep 5

      - name: Deploy Get User Data Lambda Configurations
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
          LAYER_ARN: ${{ env.LAYER_ARN }}
        run: |
          aws lambda update-function-configuration \
            --function-name xomper-get-user-data \
            --layers $LAYER_ARN \
            --region $AWS_REGION

      ## LOGIN USER
      - name: Deploy User Login Lambda Function Code
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
        run: |
          aws lambda update-function-code \
            --function-name xomper-user-login \
            --zip-file fileb://user-login.zip
          sleep 5

      - name: Deploy User Login Lambda Configurations
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
          LAYER_ARN: ${{ env.LAYER_ARN }}
        run: |
          aws lambda update-function-configuration \
            --function-name xomper-user-login \
            --layers $LAYER_ARN \
            --region $AWS_REGION

      ######################################################
      ######################################################
      ###                 LEAGUE DATA                     ##
      ######################################################
      ######################################################

      ## UPDATE LEAGUE DATA 
      - name: Deploy Update League Data Lambda Function Code
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
        run: |
          aws lambda update-function-code \
            --function-name xomper-update-league-data \
            --zip-file fileb://update-league-data.zip
          sleep 5

      - name: Deploy Update League Data Lambda Configurations
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
          LAYER_ARN: ${{ env.LAYER_ARN }}
        run: |
          aws lambda update-function-configuration \
            --function-name xomper-update-league-data \
            --layers $LAYER_ARN \
            --region $AWS_REGION

      ## GET LEAGUE DATA 
      - name: Deploy Get League Data Lambda Function Code
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
        run: |
          aws lambda update-function-code \
            --function-name xomper-get-league-data \
            --zip-file fileb://get-league-data.zip
          sleep 5

      - name: Deploy Get League Data Lambda Configurations
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
          LAYER_ARN: ${{ env.LAYER_ARN }}
        run: |
          aws lambda update-function-configuration \
            --function-name xomper-get-league-data \
            --layers $LAYER_ARN \
            --region $AWS_REGION