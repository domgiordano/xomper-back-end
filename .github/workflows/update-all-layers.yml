name: Update All Lambda Layers

on:
  workflow_dispatch:
    inputs:
      layer_arn:
        description: "Layer ARN to use (leave empty to use latest)"
        required: false
        type: string

env:
  AWS_REGION: "us-east-1"

jobs:
  get-layer-arn:
    runs-on: ubuntu-latest
    outputs:
      layer_arn: ${{ steps.get-arn.outputs.layer_arn }}
    steps:
      - name: Get layer ARN
        id: get-arn
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          if [ -n "${{ inputs.layer_arn }}" ]; then
            echo "Using provided layer ARN: ${{ inputs.layer_arn }}"
            echo "layer_arn=${{ inputs.layer_arn }}" >> $GITHUB_OUTPUT
          else
            echo "Fetching latest layer version..."
            LAYER_ARN=$(aws lambda list-layer-versions \
              --layer-name xomper-shared-packages \
              --region $AWS_REGION \
              --query 'LayerVersions[0].LayerVersionArn' \
              --output text)
            echo "Latest layer ARN: $LAYER_ARN"
            echo "layer_arn=$LAYER_ARN" >> $GITHUB_OUTPUT
          fi

  get-all-lambdas:
    runs-on: ubuntu-latest
    outputs:
      all_lambdas: ${{ steps.list-lambdas.outputs.all_lambdas }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: List all lambda folders
        id: list-lambdas
        run: |
          ALL_LAMBDAS=$(ls -d lambdas/*/ 2>/dev/null | grep -v "lambdas/common" | xargs -n1 basename | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "all_lambdas=$ALL_LAMBDAS" >> $GITHUB_OUTPUT
          echo "Found lambdas: $ALL_LAMBDAS"

  update-all-lambdas:
    needs: [get-layer-arn, get-all-lambdas]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lambda: ${{ fromJson(needs.get-all-lambdas.outputs.all_lambdas) }}
      fail-fast: false
      max-parallel: 5
    steps:
      - name: Update lambda layer
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          FUNCTION_NAME="xomper-${{ matrix.lambda }}"
          # Convert underscores to hyphens for AWS function names
          FUNCTION_NAME=$(echo $FUNCTION_NAME | tr '_' '-')

          echo "Updating layer for $FUNCTION_NAME to ${{ needs.get-layer-arn.outputs.layer_arn }}"

          aws lambda update-function-configuration \
            --function-name $FUNCTION_NAME \
            --layers ${{ needs.get-layer-arn.outputs.layer_arn }} \
            --region $AWS_REGION || echo "⚠️  Function $FUNCTION_NAME not found, skipping..."

          # Wait for update to complete
          if aws lambda get-function --function-name $FUNCTION_NAME --region $AWS_REGION &>/dev/null; then
            echo "Waiting for $FUNCTION_NAME update to complete..."
            aws lambda wait function-updated \
              --function-name $FUNCTION_NAME \
              --region $AWS_REGION || true
            echo "✅ $FUNCTION_NAME updated successfully"
          fi

  summary:
    needs: [get-layer-arn, get-all-lambdas, update-all-lambdas]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Update summary
        run: |
          echo "=== Layer Update Summary ==="
          echo "Layer ARN: ${{ needs.get-layer-arn.outputs.layer_arn }}"
          echo "Lambdas updated: ${{ needs.get-all-lambdas.outputs.all_lambdas }}"
          echo "Update job status: ${{ needs.update-all-lambdas.result }}"
          echo "=========================="
